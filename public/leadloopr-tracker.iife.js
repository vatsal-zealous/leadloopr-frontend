var LeadLoopr=(()=>{var k="leadloopr-tracker",m="data-org-id",T="data-debug",F="data-endpoint",S="data-feature-flags",D="https://api.leadloopr.com/track/lead",l={allowConsentFallback:!0,allowDynamicForms:!0};function A(){let e=document.getElementById(k);return e?.tagName==="SCRIPT"?e:Array.from(document.getElementsByTagName("script")).find(o=>o.src.includes("leadloopr-tracker.js"))||null}function I(e){let t=e.getAttribute(m);if(!t||t.trim()==="")throw new Error(`LeadLoopr: Missing required attribute "${m}" on script tag. Please add data-org-id="your-organization-id" to the script tag.`);return t.trim()}function x(e){let t=e.getAttribute(T),o=window.LEADLOOPR_DEBUG;return t!==null?t==="true"||t==="1":o===!0}function R(e){return e.getAttribute(F)?.trim()||D}function v(e){let t=e.getAttribute(S);if(!t)return l;try{let o=JSON.parse(t);return{allowConsentFallback:o.allowConsentFallback??l.allowConsentFallback,allowDynamicForms:o.allowDynamicForms??l.allowDynamicForms}}catch(o){return console.warn("LeadLoopr: Invalid feature flags JSON, using defaults:",o),l}}function P(e){if(!e.orgId||e.orgId.trim()==="")throw new Error("LeadLoopr: Organization ID cannot be empty");if(!e.endpoint||e.endpoint.trim()==="")throw new Error("LeadLoopr: Endpoint cannot be empty");try{new URL(e.endpoint)}catch{throw new Error(`LeadLoopr: Invalid endpoint URL: ${e.endpoint}`)}}function p(){let e=A();if(!e)throw new Error('LeadLoopr: Could not find tracker script tag. Make sure the script has id="leadloopr-tracker" or src contains "leadloopr-tracker.js"');let t={orgId:I(e),debug:x(e),endpoint:R(e),featureFlags:v(e)};return P(t),t.debug&&console.log("LeadLoopr: Config loaded successfully:",{orgId:t.orgId,debug:t.debug,endpoint:t.endpoint,featureFlags:t.featureFlags}),t}var O="cookie-consent",M="leadloopr_consent";function N(){return new Promise(e=>{if(typeof window.gtag!="function"){e({granted:!1,reason:"none"});return}window.gtag("consent","get",t=>{let o=t?.ad_storage==="granted"||t?.analytics_storage==="granted"||t?.functionality_storage==="granted";e({granted:o,reason:o?"google-consent":"none"})})})}function U(){let e=document.cookie.split(";"),t=e.some(o=>o.trim().startsWith(`${O}=true`));return console.log("checkCookieConsent",e),console.log("hasConsent",t),{granted:t,reason:t?"fallback-cookie":"none"}}function H(){let e=localStorage.getItem(M)==="true";return{granted:e,reason:e?"fallback-localStorage":"none"}}async function c(e){e.debug&&console.log("LeadLoopr: Checking consent status...");let t=await N();if(t.granted)return e.debug&&console.log("LeadLoopr: Consent granted via Google Consent Mode"),t;if(!e.featureFlags.allowConsentFallback)return e.debug&&console.log("LeadLoopr: Consent fallback disabled, no consent granted"),{granted:!1,reason:"none"};let o=U();if(o.granted)return e.debug&&console.log("LeadLoopr: Consent granted via cookie"),o;let r=H();return r.granted?(e.debug&&console.log("LeadLoopr: Consent granted via localStorage"),r):(e.debug&&console.log("LeadLoopr: No consent granted"),{granted:!1,reason:"none"})}function f(e,t){let o=document.createElement("div");o.id="leadloopr-consent-banner",o.style.cssText=`
    position: fixed;
    bottom: 30px;
    right: 30px;
    width: 320px;
    padding: 20px 24px;
    background: #ffffff;
    border: 1px solid #e0e0e0;
    border-radius: 12px;
    box-shadow: 0 4px 16px rgba(0, 0, 0, 0.1);
    font-family: 'Segoe UI', Roboto, sans-serif;
    z-index: 9999;
    display: flex;
    flex-direction: column;
    gap: 16px;
    font-size: 14px;
    color: #333;
  `,o.innerHTML=`
    <div style="line-height: 1.5;">
      <strong>We use cookies & tracking</strong><br/>
      This site uses a tracker to capture form and attribution data. Please accept to help us provide a better experience.
    </div>
    <div style="display: flex; justify-content: flex-end; gap: 10px;">
      <button id="llp-reject" style="
        padding: 8px 16px;
        background: #f5f5f5;
        border: 1px solid #ccc;
        border-radius: 6px;
        cursor: pointer;
        font-weight: 500;
      ">Decline</button>
      <button id="llp-accept" style="
        padding: 8px 16px;
        background: #007bff;
        color: white;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        font-weight: 500;
      ">Accept</button>
    </div>
  `,document.body.appendChild(o),document.getElementById("llp-accept")?.addEventListener("click",()=>{o.remove(),e()}),document.getElementById("llp-reject")?.addEventListener("click",()=>{o.remove(),t()})}var $=["utm_source","utm_medium","utm_campaign","utm_term","utm_content"],z=["gclid","fbclid","li_fat_id"],L="leadloopr_attribution";function j(){try{let e=document.querySelector('link[rel="canonical"]');return e?.href?e.href:window.location.href}catch{return window.location.href}}function G(e){let t={};try{let r=new URL(e).searchParams;$.forEach(a=>{let n=r.get(a);n&&n.trim()&&(t[a]=n.trim())}),z.forEach(a=>{let n=r.get(a);n&&n.trim()&&(t[a]=n.trim())})}catch(o){console.warn("LeadLoopr: Failed to parse URL parameters:",o)}return t}function B(){try{let e=document.referrer;return e&&e.trim()&&!e.startsWith(window.location.origin)?e.trim():void 0}catch(e){console.warn("LeadLoopr: Failed to get referrer:",e);return}}function q(){try{let e=sessionStorage.getItem(L);if(e)return JSON.parse(e)}catch(e){console.warn("LeadLoopr: Failed to read cached attribution:",e)}return null}function W(e){try{sessionStorage.setItem(L,JSON.stringify(e))}catch(t){console.warn("LeadLoopr: Failed to cache attribution:",t)}}function b(e){return typeof e.landing_page=="string"&&e.landing_page.length>0&&typeof e.timestamp=="number"&&e.timestamp>0}function _(e){e.debug&&console.log("LeadLoopr: Initializing attribution tracking");let t=q();if(t&&b(t))return e.debug&&console.log("LeadLoopr: Using cached attribution data"),t;let o=j(),r=G(o),a=B(),n={landing_page:o,referrer:a,...r,timestamp:Date.now()};return b(n)||(e.debug&&console.warn("LeadLoopr: Generated invalid attribution data, using fallback"),n.landing_page=window.location.href,n.timestamp=Date.now()),W(n),e.debug&&console.log("LeadLoopr: Attribution data captured:",{landing_page:n.landing_page,referrer:n.referrer,utm_params:{utm_source:n.utm_source,utm_medium:n.utm_medium,utm_campaign:n.utm_campaign,utm_term:n.utm_term,utm_content:n.utm_content},click_ids:{gclid:n.gclid,fbclid:n.fbclid,li_fat_id:n.li_fat_id},timestamp:n.timestamp}),n}var J=["name","full_name","first_name","last_name","email","user_email","phone","tel","telephone","mobile","cell"];function K(e){let t=e.toLowerCase().replace(/[_-]/g,"");return J.some(o=>t.includes(o.toLowerCase().replace(/[_-]/g,"")))}function y(e,t,o=!1){if(o&&console.log("LeadLoopr: Filtering form data for consent:",{consent:t,rawData:e}),t.granted)return o&&console.log("LeadLoopr: Consent granted, including all data"),{data:e,excluded:[]};let r={},a=[];return Object.entries(e).forEach(([n,i])=>{i&&!K(n)?r[n]=i:i&&a.push(n)}),o&&console.log("LeadLoopr: Consent not granted, filtered data:",{included:Object.keys(r),excluded:a}),{data:r,excluded:a}}var Y=[500,1500,3e3];async function X(e){return new Promise(t=>setTimeout(t,e))}async function Z(e,t,o,r){try{let a=await fetch(t,{method:"POST",headers:{"Content-Type":"application/json"},credentials:"omit",body:JSON.stringify(e)});if(!a.ok)throw new Error(`HTTP error! status: ${a.status}`);return r&&console.log("LeadLoopr: Lead payload sent successfully"),!0}catch(a){return r&&console.warn(`LeadLoopr: Send attempt ${o} failed:`,a),!1}}async function h(e,t,o=!1){o&&console.log("LeadLoopr: Sending lead payload:",e);let r=!1,a=0;for(;!r&&a<3;){if(a>0){let n=Y[a-1];o&&console.log(`LeadLoopr: Retrying in ${n}ms (attempt ${a+1}/3)`),await X(n)}r=await Z(e,t,a+1,o),a++}!r&&o&&console.error("LeadLoopr: Failed to send lead payload after all retries")}var Q={name:["name","full_name","first_name","last_name","fullname","fullName"],email:["email","user_email","userEmail","e-mail","mail"],phone:["phone","tel","telephone","mobile","cell"]};function V(e,t){for(let o of t){let r=e.querySelector(`[name="${o}"], [id="${o}"], [name*="${o}"], [id*="${o}"]`);if(r?.value)return r.value.trim()}}function ee(e){let t=new FormData(e),o={};return Object.entries(Q).forEach(([r,a])=>{let n=V(e,a);n&&(o[r]=n)}),t.forEach((r,a)=>{typeof r=="string"&&r.trim()&&(o[a]=r.trim())}),o}async function w(e,t,o){let r=e.target;if(r.hasAttribute("data-leadloopr-tracked"))return;r.setAttribute("data-leadloopr-tracked","true");let a=await c(t),n={},i=[];if(a.granted){let s=ee(r),d=y(s,a,t.debug);n=d.data,i=d.excluded,t.debug&&console.log("LeadLoopr: Consent granted, submitting form data:",{form:r.id||r.name||"unnamed",rawData:s,filteredData:n,excluded:i,attribution:o})}else t.debug&&console.log("LeadLoopr: Consent not granted, submitting form with empty data");await h({org_id:t.orgId,timestamp:Date.now(),attribution:o,consent:a,form_data:n},t.endpoint,t.debug)}function u(e,t,o){e.debug&&console.log("LeadLoopr: Initializing form tracking");let r=document.querySelectorAll("form");e.debug&&console.log(`LeadLoopr: Found ${r.length} forms to track`),r.forEach(a=>{a.addEventListener("submit",n=>w(n,e,t))}),e.featureFlags.allowDynamicForms?(new MutationObserver(n=>{n.forEach(i=>{i.addedNodes.forEach(s=>{s instanceof HTMLElement&&s.querySelectorAll("form").forEach(g=>{g.hasAttribute("data-leadloopr-tracked")||g.addEventListener("submit",E=>w(E,e,t))})})})}).observe(document.body,{childList:!0,subtree:!0}),e.debug&&console.log("LeadLoopr: Dynamic form tracking enabled")):e.debug&&console.log("LeadLoopr: Dynamic form tracking disabled"),e.debug&&console.log("LeadLoopr: Form tracking initialized")}async function te(e){e.debug&&console.log("LeadLoopr: Starting initialization");let t=await c(e),o=_(e);if(u(e,o,t),!t.granted){e.debug&&console.log("LeadLoopr: Consent not granted initially, reason:",t.reason),f(async()=>{e.debug&&console.log("LeadLoopr: User accepted consent"),document.cookie=`cookie-consent=true; path=/; max-age=${60*60*24*365}`,t=await c(e),t.granted&&(u(e,o,t),e.debug&&console.log("LeadLoopr: Tracking started after consent"))},async()=>{e.debug&&console.log("LeadLoopr: User denied consent"),document.cookie=`cookie-consent=false; path=/; max-age=${60*60*24*365}`});return}e.debug&&console.log("LeadLoopr: Initialization complete")}function C(){if(window.__LEADLOOPR_INITIALIZED__){console.warn("LeadLoopr: Script already initialized");return}let e=async()=>{try{let t=p();await te(t),window.__LEADLOOPR_INITIALIZED__=!0}catch(t){console.error("LeadLoopr: Initialization failed:",t)}};document.readyState==="loading"?document.addEventListener("DOMContentLoaded",e):e()}C();})();
